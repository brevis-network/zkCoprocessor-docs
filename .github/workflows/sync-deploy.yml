name: Sync Main to Deploy

on:
  push:
    branches:
      - main

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout main branch
      uses: actions/checkout@v4
      with:
        ref: main
        fetch-depth: 0

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install PyYAML

    - name: Process markdown files
      run: python .github/scripts/process_markdown.py

    - name: Configure Git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

    - name: Backup processed files
      run: |
        # Create backup of processed files before switching branches
        # Copy all files and directories, including hidden ones like .gitbook
        # But exclude .git and .github directories
        mkdir -p /tmp/processed_src
        find . -maxdepth 1 -not -name '.' -not -name '.git' -not -name '.github' -exec cp -r {} /tmp/processed_src/ \;
        echo "Backed up processed files"

    - name: Stash changes before branch switch
      run: |
        # Stash any changes made by the processing script to avoid branch switch conflicts
        if ! git diff --quiet || ! git diff --cached --quiet; then
          git stash push -m "Temporary stash of processed files for deploy sync"
          echo "Stashed changes before branch switch"
        else
          echo "No changes to stash"
        fi

    - name: Switch to deploy branch
      run: |
        # Fetch the latest deploy branch
        git fetch origin deploy || echo "Deploy branch doesn't exist yet, will be created"
        
        # Create or reset deploy branch to ensure clean state
        if git show-ref --verify --quiet refs/remotes/origin/deploy; then
          # Deploy branch exists remotely, check it out
          git checkout -B deploy origin/deploy
          echo "Reset to latest deploy branch"
        else
          # Deploy branch doesn't exist, create it
          git checkout --orphan deploy
          git rm -rf . 2>/dev/null || true
          echo "Created new orphan deploy branch"
        fi

    - name: Sync processed files to deploy branch
      run: |
        # Clear everything except .git
        find . -maxdepth 1 -not -name '.' -not -name '.git' -exec rm -rf {} \; 2>/dev/null || true
        
        # Copy processed files from backup
        cp -r /tmp/processed_src/* .
        
        # Also copy hidden files like .gitbook
        cp -r /tmp/processed_src/.* . 2>/dev/null || true
        
        # Create src directory and move everything there
        mkdir -p src
        find . -maxdepth 1 -not -name '.' -not -name '.git' -not -name 'src' -exec mv {} src/ \; 2>/dev/null || true
        
        echo "Synced processed files to deploy branch"
        
        # Add and commit changes
        git add .
        if ! git diff --staged --quiet; then
          git commit -m "Sync from main: $(git log main -1 --format='%h %s')"
          git push origin deploy
        else
          echo "No changes to commit"
        fi
        
        # Clean up backup
        rm -rf /tmp/processed_src

    - name: Revert changes on main branch
      run: |
        # Switch back to main branch
        git checkout main
        
        # Drop the stash to revert changes (we don't need them anymore)
        if git stash list | grep -q "Temporary stash of processed files for deploy sync"; then
          git stash drop
          echo "Dropped stash - changes reverted"
        else
          echo "No stash to drop"
        fi
        
        # Ensure we're in clean state
        git reset --hard HEAD
        
        echo "Reverted processing changes on main branch"